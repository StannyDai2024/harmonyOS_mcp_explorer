import { router } from '@kit.ArkUI'
import { QueryParams, RouteParams, ApiRequest, ApiResponse, ApiResultData, POIParams, NearbyParams, CyclingParams, DistanceParams, ToolResult } from '../types/ApiTypes';
import { HttpClient } from '../utils/HttpClient';

@Entry
@Component
struct ResultPage {
  @State queryParams?: QueryParams = undefined;
  @State queryText: string = '';
  @State loading: boolean = false;
  @State result?: ApiResultData = undefined;
  @State error: string = '';

  aboutToAppear() {
    this.loadRouteParams();
  }

  onPageShow() {
    this.performQuery();
  }

  build() {
    Column({ space: 16 }) {
      // æ ‡é¢˜æ 
      this.buildTitleBar()
      // æŸ¥è¯¢ä¿¡æ¯å±•ç¤º
      this.buildQueryInfo()
      // æŸ¥è¯¢ç»“æœå±•ç¤º
      this.buildQueryResult();
    }
    .height('100%')
    .backgroundColor($r('app.color.background'))
  }

  async performQuery() {
    this.loading = true;
    this.error = '';
    try {
      const response = await HttpClient.request({ query: this.queryText });
      if (response.success) {
        this.result = response.data;
      } else {
        this.error = response.error || 'æŸ¥è¯¢å¤±è´¥';
      }
    } catch (err) {
      this.error = 'ç½‘ç»œè¯·æ±‚å¼‚å¸¸';
    } finally {
      this.loading = false;
    }
  }

  loadRouteParams() {
    try {
      const params = router.getParams() as RouteParams;
      console.log('params', JSON.stringify(params, null, 2))
      if (params) {
        this.queryParams = params.queryParams;
        this.queryText = params.queryText || '';
      }
    } catch (error) {
      console.error('è·å–è·¯ç”±å‚æ•°å¤±è´¥ï¼š', error);
      this.error = 'é¡µé¢å‚æ•°è·å–å¤±è´¥';
    }
  }

  @Builder
  buildTitleBar() {
    Row() {
      Button() {
        Text('â†')
          .fontSize(24)
          .fontColor($r('app.color.text_primary'))
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
      .onClick(() => {
        router.back();
      })

      Text('æŸ¥è¯¢ç»“æœ')
        .fontSize(20)
        .fontWeight(FontWeight.Bold)
        .fontColor($r('app.color.text_primary'))
        .layoutWeight(1)
        .textAlign(TextAlign.Center)

      // å ä½æŒ‰é’®ï¼Œä¿æŒæ ‡é¢˜å±…ä¸­
      Button() {
        // ç©ºç™½å ä½
      }
      .width(40)
      .height(40)
      .backgroundColor(Color.Transparent)
    }
    .width('100%')
    .height(56)
    .padding({ left: 16, right: 16 })
    .backgroundColor($r('app.color.surface'))
  }


  @Builder
  buildQueryInfo() {
    Column({ space: 12 }) {
      Text('æŸ¥è¯¢ä¿¡æ¯')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
        .alignSelf(ItemAlign.Start)

      Column({ space: 8 }) {
        Row() {
          Text('æŸ¥è¯¢ç±»å‹ï¼š')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
          Text(this.getQueryTypeLabel())
            .fontSize(14)
            .fontColor($r('app.color.text_primary'))
            .fontWeight(FontWeight.Medium)
        }
        .alignItems(VerticalAlign.Center)
        .alignSelf(ItemAlign.Start)

        Row() {
          Text('æŸ¥è¯¢å†…å®¹ï¼š')
            .fontSize(14)
            .fontColor($r('app.color.text_secondary'))
          Text(this.queryText)
            .fontSize(14)
            .fontColor($r('app.color.text_primary'))
            .layoutWeight(1)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .maxLines(2)
        }
        .alignItems(VerticalAlign.Top)
        .alignSelf(ItemAlign.Start)
        .width('100%')
      }
      .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor($r('app.color.surface'))
    .borderRadius(8)
  }

  @Builder
  buildQueryResult() {
    // åŠ è½½çŠ¶æ€æˆ–ç»“æœå±•ç¤º
    if (this.loading) {
      this.buildLoadingView()
    } else if (this.error) {
      this.buildErrorView()
    } else if (this.result) {
      this.buildResultView()
    }
  }

  @Builder
  buildLoadingView() {
    Column({ space: 16 }) {
      LoadingProgress()
        .width(48)
        .height(48)
        .color($r('app.color.brand_primary'))

      Text('æ­£åœ¨æŸ¥è¯¢ä¸­...')
        .fontSize(16)
        .fontColor($r('app.color.text_secondary'))
    }
    .justifyContent(FlexAlign.Center)
    .width('100%')
    .height(200)
  }

  @Builder
  buildErrorView() {
    Column({ space: 16 }) {
      Text('âŒ')
        .fontSize(64)

      Text('æŸ¥è¯¢å¤±è´¥')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))

      Text(this.error)
        .fontSize(14)
        .fontColor($r('app.color.text_secondary'))
        .textAlign(TextAlign.Center)
        .maxLines(3)

      Button('é‡æ–°æŸ¥è¯¢')
        .width(120)
        .height(40)
        .fontSize(16)
        .backgroundColor($r('app.color.brand_primary'))
        .onClick(() => {
          this.error = '';
          this.performQuery();
        })
    }
    .justifyContent(FlexAlign.Center)
    .width('100%')
    .height(300)
  }

  @Builder
  buildResultView() {
    Scroll() {
      Column({ space: 16 }) {
        Text('æŸ¥è¯¢ç»“æœ')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
          .alignSelf(ItemAlign.Start)

        this.buildVisualizedResult()

        // æ“ä½œæŒ‰é’®
        Row({ space: 8 }) {
          Button('è¿”å›')
            .width(0)
            .height(44)
            .fontSize(16)
            .backgroundColor($r('app.color.surface'))
            .fontColor($r('app.color.text_primary'))
            .layoutWeight(1)
            .onClick(() => {
              router.back();
            })
        }
        .width('100%')
        .margin({ top: 20 })

        // åœ¨æœ€ååŠ ä¸ªå«ç‰‡ï¼Œé¿å…è¢«è¦†ç›–
        Blank().height(180) // å…ˆè¯• 80ï¼Œæ ¹æ®å®é™…å†å¾®è°ƒ
      }
      .width('100%')
      .padding(16)
    }
  }

  @Builder
  buildVisualizedResult() {
    Column({ space: 16 }) {
      // å·¥å…·è°ƒç”¨å±•ç¤º
      if (this.result?.toolResults && Array.isArray(this.result.toolResults)) {
        this.buildToolResults()
      }

      // æ¶ˆæ¯å†…å®¹å±•ç¤º
      this.buildMessageContent()
    }
    .width('100%')
  }


  @Builder
  buildToolResults() {
    Column({ space: 12 }) {
      Text('ğŸ”§ å·¥å…·è°ƒç”¨è¯¦æƒ…')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor($r('app.color.text_primary'))
        .alignSelf(ItemAlign.Start)

      ForEach(this.result?.toolResults || [], (tool: ToolResult, index: number) => {
        this.buildToolItem(tool, index)
      })
    }
    .width('100%')
  }

  @Builder
  buildToolItem(tool: ToolResult, index: number) {
    Column({ space: 8 }) {
      // å·¥å…·å¤´éƒ¨
      Row({ space: 8 }) {
        Text(`#${index + 1}`)
          .fontSize(12)
          .fontColor($r('app.color.text_secondary'))
          .backgroundColor($r('app.color.background'))
          .padding({ left: 6, right: 6, top: 2, bottom: 2 })
          .borderRadius(4)

        Text(this.getToolName(tool))
          .fontSize(14)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
          .layoutWeight(1)

        Text('ğŸ”§')
          .fontSize(16)
      }
      .width('100%')
      .alignItems(VerticalAlign.Center)

      // å·¥å…·è¯¦æƒ…
      Text(this.getToolDescription(tool))
        .fontSize(13)
        .fontColor($r('app.color.text_secondary'))
        .textAlign(TextAlign.Start)
        .width('100%')
        .maxLines(3)
        .textOverflow({ overflow: TextOverflow.Ellipsis })
    }
    .width('100%')
    .padding(12)
    .backgroundColor($r('app.color.surface'))
    .borderRadius(6)
    .border({
      width: 1,
      color: $r('app.color.background')
    })
  }

  @Builder
  buildMessageContent() {
    if (this.result?.message) {
      Column({ space: 8 }) {
        Text('ğŸ’¬ å“åº”æ¶ˆæ¯')
          .fontSize(16)
          .fontWeight(FontWeight.Medium)
          .fontColor($r('app.color.text_primary'))
          .alignSelf(ItemAlign.Start)

        Text(this.result.message)
          .fontSize(14)
          .fontColor($r('app.color.text_primary'))
          .backgroundColor($r('app.color.surface'))
          .padding(16)
          .borderRadius(8)
          .width('100%')
          .copyOption(CopyOptions.InApp)
      }
      .width('100%')
    }
  }

  @State showRawData: boolean = false;

  getToolName(tool: ToolResult): string {
    return tool?.name || 'æœªçŸ¥å·¥å…·';
  }

  getToolDescription(tool: ToolResult): string {
    if (tool?.status) {
      const statusText = tool.status === 'SUCCESS' ? 'âœ… æ‰§è¡ŒæˆåŠŸ' : 'âŒ æ‰§è¡Œå¤±è´¥';
      let description = statusText;
      
      if (tool.request) {
        const requestKeys = Object.keys(tool.request);
        if (requestKeys.length > 0) {
          const params = requestKeys.map(key => `${key}: ${tool.request![key]}`).join(', ');
          description += `\nå‚æ•°: ${params}`;
        }
      }
      
      if (tool.response && tool.response.length > 0) {
        const firstResponse = tool.response[0];
        if (firstResponse.text && firstResponse.text.length > 0) {
          const previewText = firstResponse.text.length > 100 
            ? firstResponse.text.substring(0, 100) + '...' 
            : firstResponse.text;
          description += `\nè¿”å›: ${previewText}`;
        }
      }
      
      return description;
    }
    
    return 'å·¥å…·è°ƒç”¨è¯¦æƒ…';
  }

  getQueryTypeLabel(): string {
    if (!this.queryParams) return '';

    switch (this.queryParams.type) {
      case 'weather': return 'å¤©æ°”æŸ¥è¯¢';
      case 'poi': return 'POIæŸ¥è¯¢';
      case 'nearby': return 'å‘¨è¾¹æœç´¢';
      case 'distance': return 'è·ç¦»æµ‹é‡';
      case 'cycling': return 'éª‘è¡Œè§„åˆ’';
      default: return 'æœªçŸ¥ç±»å‹';
    }
  }
}